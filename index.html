<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æè¯å™¨ V3.0 (å¤šå‰§æœ¬ç®¡ç†ç‰ˆ)</title>


    <style>
        /* --- 1. åŸºç¡€é‡ç½® --- */
        body {
            margin: 0; padding: 0;
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 2. æè¯ä¸»åŒºåŸŸ --- */
        #prompter-container {
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ */
            width: 100%;
            overflow-y: auto;
            padding: 50vh 20px 50vh 20px; 
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            scroll-behavior: auto; /* JSæ§åˆ¶æ»šåŠ¨ï¼ŒCSSè®¾ä¸ºauto */
        }

        #content {
            outline: none;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 32px; 
            min-height: 200px;
        }

        .mirror-x { transform: scaleX(-1); }

        /* --- 3. è¾…åŠ©çº¿ --- */
        #guide-line {
            position: fixed; top: 40%; left: 0; width: 100%; height: 1px;
            background: rgba(255, 0, 0, 0.4); pointer-events: none; z-index: 2;
        }

        /* --- 4. åº•éƒ¨æ§åˆ¶æ  --- */
        #controls {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.95);
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            padding: 12px 10px 20px 10px;
            display: flex; flex-wrap: wrap; 
            justify-content: space-between; align-items: center; gap: 10px;
            z-index: 100; border-top: 1px solid #333;
            transition: transform 0.3s;
        }
        
        body.hide-controls #controls { transform: translateY(110%); }

        /* æ§ä»¶æ ·å¼ */
        .control-group { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 100px; }
        label { font-size: 12px; color: #aaa; white-space: nowrap; }
        input[type="range"] { flex-grow: 1; height: 20px; }
        
        button {
            padding: 10px 15px; background: #007bff; border: none; color: white;
            border-radius: 8px; font-size: 14px; font-weight: bold; flex-shrink: 0;
        }
        button.active { background: #dc3545; } 
        button.outline { background: transparent; border: 1px solid #555; color: #ccc; }

        /* å‰§æœ¬ç®¡ç†æŒ‰é’®ç‰¹åˆ«æ ·å¼ */
        #btn-scripts { background: #28a745; }

        /* --- 5. å‰§æœ¬ç®¡ç†æŠ½å±‰ (Drawer) --- */
        #script-drawer {
            position: fixed; top: 0; right: 0; height: 100%; width: 300px;
            background: #1a1a1a; z-index: 200;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            transform: translateX(100%); /* é»˜è®¤éšè— */
            transition: transform 0.3s ease-out;
            display: flex; flex-direction: column;
        }
        #script-drawer.open { transform: translateX(0); }

        /* é®ç½©å±‚ */
        #drawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 199;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        #drawer-overlay.visible { display: block; opacity: 1; }

        /* æŠ½å±‰å†…å®¹ */
        .drawer-header {
            padding: 20px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-header h3 { margin: 0; font-size: 18px; }
        .close-btn { background: none; border: none; font-size: 24px; color: #999; padding: 0;}

        .drawer-body { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* ä¿å­˜è¡¨å• */
        .save-box { display: flex; gap: 5px; margin-bottom: 20px; }
        .save-box input {
            flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #444;
            background: #222; color: white;
        }
        .save-box button { padding: 8px 12px; font-size: 12px; }

        /* åˆ—è¡¨é¡¹ */
        .script-item {
            background: #2a2a2a; padding: 12px; border-radius: 6px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #333;
        }
        .script-info { flex: 1; overflow: hidden; }
        .script-title { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: block;}
        .script-date { font-size: 10px; color: #888; }
        
        .script-actions button {
            padding: 4px 8px; font-size: 12px; margin-left: 5px; background: #444;
        }
        .script-actions .btn-load { background: #007bff; }
        .script-actions .btn-del { background: #dc3545; }

        /* --- 6. ç§»åŠ¨ç«¯é€‚é… --- */
        @media (max-width: 600px) {
            #script-drawer { width: 100%; } /* æ‰‹æœºä¸Šå…¨å±æˆ–åº•éƒ¨å¼¹å‡º */
            #btn-toggle { width: 100%; margin-bottom: 8px; padding: 14px; }
            .control-group { min-width: 45%; } /* ä¸¤åˆ—æ’å¸ƒ */
        }
    </style>
</head>
<body>
    <div id="guide-line"></div>

    <div id="prompter-container">
        <div id="content" contenteditable="true"></div>
    </div>

    <div id="controls">
        <button id="btn-toggle">å¼€å§‹æ»šåŠ¨</button>
        
        <div class="control-group">
            <label>é€Ÿåº¦</label>
            <input type="range" id="input-speed" min="1" max="15" step="0.5" value="2">
        </div>

        <div class="control-group">
            <label>å­—å·</label>
            <input type="range" id="input-size" min="16" max="80" value="32">
        </div>

        <div style="display:flex; gap:10px; width:100%; margin-top:5px;">
             <button id="btn-scripts" style="flex:1">ğŸ“‚ å‰§æœ¬ç®¡ç†</button>
             <button id="btn-mirror" class="outline">â†” é•œåƒ</button>
             <button id="btn-reset" class="outline">Top</button>
        </div>
    </div>

    <div id="drawer-overlay"></div>

    <div id="script-drawer">
        <div class="drawer-header">
            <h3>æˆ‘çš„å‰§æœ¬åº“</h3>
            <button class="close-btn" id="btn-close-drawer">Ã—</button>
        </div>
        <div class="drawer-body">
            <div class="save-box">
                <input type="text" id="input-title" placeholder="è¾“å…¥å‰§æœ¬æ ‡é¢˜...">
                <button id="btn-save-new">ä¿å­˜å½“å‰æ–‡æ¡ˆ</button>
            </div>
            
            <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">
            
            <div id="script-list">
                </div>

            <div style="margin-top: 30px; text-align: center;">
                 <button id="btn-download" class="outline" style="width:100%">â¬‡ï¸ å¯¼å‡ºå½“å‰æ–‡æœ¬ä¸ºTXT</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM å…ƒç´  ---
        const container = document.getElementById('prompter-container');
        const content = document.getElementById('content');
        const btnToggle = document.getElementById('btn-toggle');
        const controls = document.getElementById('controls');
        
        // å‰§æœ¬ç®¡ç†ç›¸å…³
        const drawer = document.getElementById('script-drawer');
        const overlay = document.getElementById('drawer-overlay');
        const scriptListEl = document.getElementById('script-list');
        const inputTitle = document.getElementById('input-title');

        // çŠ¶æ€å˜é‡
        let isScrolling = false;
        let scrollSpeed = 2;
        let animationId = null;
        let lastScrollTime = 0;
        let isMirror = false;

        // --- 1. æ ¸å¿ƒæ»šåŠ¨åŠŸèƒ½ (ä¿æŒ V2 ä¸å˜) ---
        function autoScroll(timestamp) {
            if (!isScrolling) return;
            if (timestamp - lastScrollTime >= 16) {
                const speedFactor = window.innerWidth < 600 ? 0.4 : 0.5;
                container.scrollTop += (scrollSpeed * speedFactor); 
                lastScrollTime = timestamp;
            }
            if (Math.ceil(container.scrollTop + container.clientHeight) >= container.scrollHeight - 2) {
                stopScroll();
            } else {
                animationId = requestAnimationFrame(autoScroll);
            }
        }

        function toggleScroll() {
            if (isScrolling) {
                isScrolling = false;
                btnToggle.textContent = "å¼€å§‹æ»šåŠ¨";
                btnToggle.classList.remove('active');
                content.contentEditable = "true"; 
                cancelAnimationFrame(animationId);
            } else {
                isScrolling = true;
                btnToggle.textContent = "æš‚åœ";
                btnToggle.classList.add('active');
                content.contentEditable = "false"; 
                container.focus();
                animationId = requestAnimationFrame(autoScroll);
            }
        }

        document.getElementById('btn-toggle').addEventListener('click', toggleScroll);
        
        // --- 2. åŸºç¡€è®¾ç½®æ§åˆ¶ ---
        document.getElementById('input-speed').addEventListener('input', (e) => {
            scrollSpeed = Number(e.target.value);
            autoSaveTemp(); // è°ƒæ•´ä¹Ÿè§¦å‘ä¸´æ—¶ä¿å­˜
        });
        document.getElementById('input-size').addEventListener('input', (e) => {
            content.style.fontSize = e.target.value + 'px';
            autoSaveTemp();
        });
        document.getElementById('btn-reset').addEventListener('click', () => {
            if(isScrolling) toggleScroll();
            container.scrollTop = 0;
        });
        document.getElementById('btn-mirror').addEventListener('click', (e) => {
            isMirror = !isMirror;
            if(isMirror) {
                container.classList.add('mirror-x');
                e.target.style.background = '#444';
            } else {
                container.classList.remove('mirror-x');
                e.target.style.background = 'transparent';
            }
        });

        // --- 3. è‡ªåŠ¨ä¿å­˜ï¼ˆä¸´æ—¶è‰ç¨¿ï¼‰ ---
        // å³ä½¿ä¸ç‚¹å‡»ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢ä¹Ÿåº”è¯¥ä¿ç•™å½“å‰å†…å®¹
        function autoSaveTemp() {
            localStorage.setItem('temp_content', content.innerHTML);
            localStorage.setItem('temp_settings', JSON.stringify({
                speed: document.getElementById('input-speed').value,
                size: document.getElementById('input-size').value
            }));
        }

        function loadTemp() {
            const tempTxt = localStorage.getItem('temp_content');
            if(tempTxt) content.innerHTML = tempTxt;
            else content.innerHTML = "æ¬¢è¿ä½¿ç”¨ï¼\nç‚¹å‡»æ­¤å¤„ç¼–è¾‘æ–‡æœ¬ï¼Œæˆ–ç‚¹å‡»å³ä¸‹è§’ã€å‰§æœ¬ç®¡ç†ã€‘ä¿å­˜å’Œåˆ‡æ¢å‰§æœ¬ã€‚";

            const tempSet = JSON.parse(localStorage.getItem('temp_settings'));
            if(tempSet) {
                document.getElementById('input-speed').value = tempSet.speed;
                document.getElementById('input-size').value = tempSet.size;
                scrollSpeed = Number(tempSet.speed);
                content.style.fontSize = tempSet.size + 'px';
            }
        }

        content.addEventListener('input', autoSaveTemp);
        window.addEventListener('DOMContentLoaded', loadTemp);

        // --- 4. å¤šå‰§æœ¬ç®¡ç†ç³»ç»Ÿ (æ ¸å¿ƒæ–°å¢) ---
        
        // æ‰“å¼€/å…³é—­æŠ½å±‰
        function toggleDrawer(show) {
            if(show) {
                drawer.classList.add('open');
                overlay.classList.add('visible');
                renderScriptList(); // æ‰“å¼€æ—¶åˆ·æ–°åˆ—è¡¨
            } else {
                drawer.classList.remove('open');
                overlay.classList.remove('visible');
            }
        }

        document.getElementById('btn-scripts').addEventListener('click', () => toggleDrawer(true));
        document.getElementById('btn-close-drawer').addEventListener('click', () => toggleDrawer(false));
        overlay.addEventListener('click', () => toggleDrawer(false));

        // è·å–ä¿å­˜çš„æ‰€æœ‰å‰§æœ¬
        function getSavedScripts() {
            return JSON.parse(localStorage.getItem('my_scripts') || '[]');
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderScriptList() {
            const scripts = getSavedScripts();
            scriptListEl.innerHTML = '';

            if(scripts.length === 0) {
                scriptListEl.innerHTML = '<div style="color:#666; text-align:center; margin-top:20px;">æš‚æ— ä¿å­˜çš„å‰§æœ¬</div>';
                return;
            }

            // æŒ‰æ—¶é—´å€’åº
            scripts.sort((a, b) => b.timestamp - a.timestamp).forEach(item => {
                const div = document.createElement('div');
                div.className = 'script-item';
                div.innerHTML = `
                    <div class="script-info">
                        <span class="script-title">${item.title}</span>
                        <span class="script-date">${new Date(item.timestamp).toLocaleString()}</span>
                    </div>
                    <div class="script-actions">
                        <button class="btn-load" data-id="${item.id}">è½½å…¥</button>
                        <button class="btn-del" data-id="${item.id}">åˆ é™¤</button>
                    </div>
                `;
                scriptListEl.appendChild(div);
            });

            // ç»‘å®šäº‹ä»¶
            document.querySelectorAll('.btn-load').forEach(btn => {
                btn.addEventListener('click', (e) => loadScript(e.target.dataset.id));
            });
            document.querySelectorAll('.btn-del').forEach(btn => {
                btn.addEventListener('click', (e) => deleteScript(e.target.dataset.id));
            });
        }

        // ä¿å­˜æ–°å‰§æœ¬
        document.getElementById('btn-save-new').addEventListener('click', () => {
            const title = inputTitle.value.trim();
            if(!title) { alert('è¯·è¾“å…¥æ ‡é¢˜'); return; }
            if(!content.innerText.trim()) { alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }

            const scripts = getSavedScripts();
            const newScript = {
                id: Date.now().toString(),
                title: title,
                content: content.innerHTML,
                timestamp: Date.now()
            };

            scripts.push(newScript);
            localStorage.setItem('my_scripts', JSON.stringify(scripts));
            
            inputTitle.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            renderScriptList(); // åˆ·æ–°åˆ—è¡¨
            alert('ä¿å­˜æˆåŠŸï¼');
        });

        // è½½å…¥å‰§æœ¬
        function loadScript(id) {
            if(!confirm('è½½å…¥æ–°å‰§æœ¬ä¼šè¦†ç›–å½“å‰ç¼–è¾‘åŒºçš„å†…å®¹ï¼Œç¡®å®šå—ï¼Ÿ')) return;
            
            const scripts = getSavedScripts();
            const target = scripts.find(s => s.id === id);
            if(target) {
                content.innerHTML = target.content;
                autoSaveTemp(); // ç«‹å³æ›´æ–°ä¸´æ—¶å­˜å‚¨
                toggleDrawer(false); // å…³é—­æŠ½å±‰
            }
        }

        // åˆ é™¤å‰§æœ¬
        function deleteScript(id) {
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‰§æœ¬å—ï¼Ÿæ— æ³•æ¢å¤ã€‚')) return;
            
            let scripts = getSavedScripts();
            scripts = scripts.filter(s => s.id !== id);
            localStorage.setItem('my_scripts', JSON.stringify(scripts));
            renderScriptList();
        }

        // å¯¼å‡º txt
        document.getElementById('btn-download').addEventListener('click', () => {
            const text = content.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (inputTitle.value || 'æè¯å™¨æ–‡ç¨¿') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // --- 5. äº¤äº’ç»†èŠ‚ä¼˜åŒ– ---
        // é”®ç›˜å¼¹èµ·éšè—æ§åˆ¶æ 
        content.addEventListener('focus', () => document.body.classList.add('hide-controls'));
        content.addEventListener('blur', () => setTimeout(() => document.body.classList.remove('hide-controls'), 300));
        container.addEventListener('click', (e) => {
            if(e.target === container) {
                content.blur();
                if(isScrolling) toggleScroll();
            }
        });

    </script>
</body>
</html>